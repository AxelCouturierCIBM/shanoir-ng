name: Deploy to qualif
run-name: deploy ${{ inputs.commit }} to ${{ inputs.neurinfo && 'neurinfo' || '-' }},${{ inputs.ofsep && 'ofsep' || '-'}} by ${{ inputs.owner }}

on:
  workflow_dispatch:
    inputs:
      commit:
        description: "commit id to be deployed"
        required: true
      owner:
        description: "person who triggered this workflow"
        required: true
      deploy_id:
        description: "unique id for this deployment"
        required: true
      neurinfo:
        type: boolean
        required: true
      ofsep:
        type: boolean
        required: true

jobs:
  build:
    uses: ./.github/workflows/docker.yml
    with:
      commit: "${{ inputs.commit }}"

  deploy:
    needs: build
    runs-on: shanoir-deploy
    environment: qualif
    env:
      url:        ${{ secrets.SHANOIR_DEPLOY_URL }}
      token:      ${{ secrets.SHANOIR_DEPLOY_TOKEN }}
      deploy_id:  ${{ inputs.deploy_id }}
    strategy:
      matrix:
        instance:
          - { name: neurinfo, enabled: "${{ inputs.neurinfo }}" }
          - { name: ofsep,    enabled: "${{ inputs.ofsep }}" }
    steps:
      - name: "deploy commit ${{ needs.build.outputs.sha }}"
        run: 'echo deploy to ${{ matrix.instance.name }}'
        if: ${{ matrix.instance.enabled }}

#    steps:
#      - env:
#          instance: neurinfo-qualif
#        name: "deploy to ${{ env.instance }} commit ${{ needs.build.outputs.sha }}"
#        run: |
#          base64 <<EOF
#          echo curl --fail --no-progress-meter -H "Authorization: Token $token" -d "deploy_id=$deploy_id" -d "instance=$instance" -X POST -- "$url"
#          EOF
#      - env:
#          instance: ofsep-qualif
#        name: "deploy to ${{ env.instance }}"
#        run: |
#          echo curl --fail --no-progress-meter -H "Authorization: Token $token" -d "deploy_id=$deploy_id" -d "instance=$instance" -X POST -- "$url"
